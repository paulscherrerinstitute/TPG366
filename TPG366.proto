InTerminator = CR LF;
# No outTerminator because we need to send ENQ clean or RS485 will mess up the reply.

handshake { in ACK; out ENQ; }

debug {
    out "%s\r"; handshake;
    in "%#s";
}

set_mbar {
    out "UNI,0\r"; handshake; in "0"; 
}

display_sendor_id {
    out "DCB,0,12\r"; handshake; in "0,12";
}

save {
    out "SAV,1\r"; handshake; in "0000";
}

read_onoff {
    out "SEN\r"; handshake;
    in "%(\$1:ONOFFG1.RVAL)d,"
       "%(\$1:ONOFFG2.RVAL)d,"
       "%(\$1:ONOFFG3.RVAL)d,"
       "%(\$1:ONOFFG4.RVAL)d,"
       "%(\$1:ONOFFG5.RVAL)d,"
       "%(\$1:ONOFFG6.RVAL)d";
}

set_onoff1 {
    out "SEN,%{1|2},0,0,0,0,0\r"; handshake;
    in "%*d,%*d,%*d,%*d,%*d,%*d";
}
set_onoff2 {
    out "SEN,0,%{1|2},0,0,0,0\r"; handshake;
    in "%*d,%*d,%*d,%*d,%*d,%*d";
}
set_onoff3 {
    out "SEN,0,0,%{1|2},0,0,0\r"; handshake;
    in "%*d,%*d,%*d,%*d,%*d,%*d";
}
set_onoff4 {
    out "SEN,0,0,0,%{1|2},0,0\r"; handshake;
    in "%*d,%*d,%*d,%*d,%*d,%*d";
}
set_onoff5 {
    out "SEN,0,0,0,0,%{1|2},0\r"; handshake;
    in "%*d,%*d,%*d,%*d,%*d,%*d";
}
set_onoff6 {
    out "SEN,0,0,0,0,0,%{1|2}\r"; handshake;
    in "%*d,%*d,%*d,%*d,%*d,%*d";
}

read_pressure_and_status {
    out "PRX\r"; handshake;
    in "%(\$1:STATUS1)d,%(\$1:PRESSURE1.A)f,"
       "%(\$1:STATUS2)d,%(\$1:PRESSURE2.A)f,"
       "%(\$1:STATUS3)d,%(\$1:PRESSURE3.A)f,"
       "%(\$1:STATUS4)d,%(\$1:PRESSURE4.A)f,"
       "%(\$1:STATUS5)d,%(\$1:PRESSURE5.A)f,"
       "%(\$1:STATUS6)d,%(\$1:PRESSURE6.A)f";
}

read_gauge_type {
    out "TID\r"; handshake;
    in "%(\$1:TYPE1)[^,],"
       "%(\$1:TYPE2)[^,],"
       "%(\$1:TYPE3)[^,],"
       "%(\$1:TYPE4)[^,],"
       "%(\$1:TYPE5)[^,],"
       "%(\$1:TYPE6)[^,]";
}

read_names {
    out "CID\r"; handshake;
    in "%#/_+(?=,|$)//"  # remove all trailing _ from the names
       "%#/_/ /"         # replace _ with space
       "%(\$1:NAME1)[^,],"
       "%(\$1:NAME2)[^,],"
       "%(\$1:NAME3)[^,],"
       "%(\$1:NAME4)[^,],"
       "%(\$1:NAME5)[^,],"
       "%(\$1:NAME6)[^,]";
}

set_names {
    out "CID,%(\$1:NAME1).8s,"
            "%(\$1:NAME2).8s,"
            "%(\$1:NAME3).8s,"
            "%(\$1:NAME4).8s,"
            "%(\$1:NAME5).8s,"
            "%(\$1:NAME6).8s\r"
        "%#/ /_/";   # replace space with _
    handshake;
    in "%#/_+(?=,|$)//"  # remove all trailing _ from the names
       "%#/_/ /"         # replace _ with space
       "%(\$1:NAME1)[^,],"
       "%(\$1:NAME2)[^,],"
       "%(\$1:NAME3)[^,],"
       "%(\$1:NAME4)[^,],"
       "%(\$1:NAME5)[^,],"
       "%(\$1:NAME6)[^,]";
    save;
}

read_gas {
    out "GAS\r"; handshake;
    in "%(\$1:GAS1)d,"
       "%(\$1:GAS2)d,"
       "%(\$1:GAS3)d,"
       "%(\$1:GAS4)d,"
       "%(\$1:GAS5)d,"
       "%(\$1:GAS6)d";
}

set_gas {
    out "GAS,%(\$1:GAS1)d,"
            "%(\$1:GAS2)d,"
            "%(\$1:GAS3)d,"
            "%(\$1:GAS4)d,"
            "%(\$1:GAS5)d,"
            "%(\$1:GAS6)d\r";
    handshake;
    in "%(\$1:GAS1)d,"
       "%(\$1:GAS2)d,"
       "%(\$1:GAS3)d,"
       "%(\$1:GAS4)d,"
       "%(\$1:GAS5)d,"
       "%(\$1:GAS6)d";
}

read_status {
    set_mbar;
    read_onoff;
    read_pressure_and_status;
}

read_infos {
    @init {
        out "\r"; in "%*#s";
        display_sendor_id;
        read_gauge_type;
        read_names;
        read_gas;
    }
    read_gauge_type;
    read_names;
    read_gas;
}

read_relay_status {
    out "SPS\r"; handshake;
    in "%(\$1:RELAY1){0|1},"
       "%(\$1:RELAY2){0|1},"
       "%(\$1:RELAY3){0|1},"
       "%(\$1:RELAY4){0|1},"
       "%(\$1:RELAY5){0|1},"
       "%(\$1:RELAY6){0|1}";
}

get_relay_setpoint {
    out "SP\$2\r"; handshake;
    in "%(\$1:RELAY\$2-SOURCE)d,%(\$1:RELAY\$2-LOW)E,%(\$1:RELAY\$2-HIGH)E";
}

set_relay_setpoint {
    @init {
        out "\r"; in "%*#s";
        get_relay_setpoint;
    }
    out "SP\$2,%(\$1:RELAY\$2-SOURCE)d,%(\$1:RELAY\$2-LOW).4E,%(\$1:RELAY\$2-HIGH).4E\r";
    handshake;
    in "%*d,%*E,%*E";
    save;
}
